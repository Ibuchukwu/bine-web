<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bine | Login to your Administrtive account</title>
        <link rel="icon" type="image/png" href="bine.png">
        <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500&display=swap" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
        <link rel="stylesheet" href="styles.css"/>
    </head>
    <body>
        <div id="login-fieldset">
            <div class="logo-top">
                <img src="bine.png" alt="Bine logo" class="logo">
                <!--<h3> Bine</h3>-->
            </div>
            <h3 style="text-align: center;">Login to your Administrtive Account</h3><hr>
            <fieldset>
                <form id="auth">
                <label for="email">Input Email</label>
                <input type="email" id="email" autocomplete="email"><br>
                <label for="password">Input password</label>
                <input type="password" id="password" autocomplete="current-password"><br>
                <button type="button" id="login_button" class="btn btn-primary" onclick="login()">Login</button><br>
                </form>
            </fieldset>
            <h5 style="text-align: center;">Forgot Password? <a style="color: blue;" href="./reset_password.html">Click Here</a> to Reset <a href="./dashboard.html">mm</a>Password</h5>
        </div>
        <script type="module">
import { auth } from "./firebase.js";
import { notice } from "./utility.js";
import { signInWithEmailAndPassword, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

connectAuthEmulator(auth, "http://localhost:9099");
function login(){
  document.getElementById("login_button").innerHTML = `<i class="fa-solid fa-spinner fa-spin-pulse" style="margin: auto; color: white;"></i>`;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    /*signInWithEmailAndPassword(auth, email, password)
  .then(userCredential => {
    console.log("User signed in:", userCredential.user);
    notice("Login successful", "success");
    setTimeout(function () {
      window.location.href = "dashboard.html";
    }, 4000);
  })
  .catch(error => {
    console.error("Authentication error:", error);
    notice("Login failed", "error");
    setTimeout(function () {
      // delay or reload
    }, 4000);
  });
    */signInWithEmailAndPassword(auth, email, password).then(userCredential => {
                return userCredential.user.getIdToken(); // ðŸ”‘ Get ID token
            }).then(idToken => {
            // ðŸ” Send ID token to your backend
            return fetch("/api/verify-token", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "authorization": `Bearer ${idToken}`
            },
            body: JSON.stringify({}),
            });
  })
  .then(response => response.json())
  .then(data => {
    console.log("User verified on server:", data);
    document.getElementById("login_button").innerHTML = `Login`;
    notice(data.message, "success");
    setTimeout(function() {
        window.location.href = "dashboard.html";
    }, 5000);
  })
  .catch(error => {
  console.error("Authentication error:", error);
  if (!error.code) {
    notice("Unknown error occurred", "error");
    return;
  }
  switch (error.code) {
    case 'auth/user-not-found':
      notice("User not found. Please check your email or sign up.", "error");
      break;
    case 'auth/wrong-password':
      notice("Incorrect password. Please try again.", "error");
      break;
    case 'auth/invalid-email':
      notice("Invalid email format. Please enter a valid email.", "error");
      break;
    case 'auth/too-many-requests':
      notice("Too many attempts. Please try again later.", "error");
      break;
    case 'auth/user-disabled':
      notice("This account has been disabled.", "error");
      break;
    default:
      notice("Authentication failed. Please try again.", "error");
  }
  setTimeout(() => {
    // Clear error message or reset form after 5 seconds
  }, 5000);
});
}

window.login = login;
        </script>
    </body>
</html>